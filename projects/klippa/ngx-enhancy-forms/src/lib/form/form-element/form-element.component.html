<ng-template #errorRef let-forCalculation="forCalculation">
	<div *ngIf="shouldShowErrorMessages() && getErrorToShow(forCalculation)" class="errorContainer" [ngClass]="{hasCaption: caption || captionRef, 'd30-70': spaceDistribution === '30-70', 'd34-66': spaceDistribution === '34-66'}" [klpWithTooltip]="!errorMessageAsTooltip && getErrorLocation() === 'rightOfCaption'">
		<div *ngIf="showDefaultError('min')">{{substituteParameters(getErrorMessage("min"), {min: attachedControl.errors.min.min})}}</div>
		<div *ngIf="showDefaultError('max')">{{substituteParameters(getErrorMessage("max"), {max: attachedControl.errors.max.max})}}</div>
		<div *ngIf="showDefaultError('required')">{{getErrorMessage("required")}}</div>
		<div *ngIf="showDefaultError('email')">{{getErrorMessage("email")}}</div>
		<div *ngIf="showDefaultError('minlength')">{{substituteParameters(getErrorMessage("minLength"), {minLength: attachedControl.errors.minlength.requiredLength})}}</div>
		<div *ngIf="showDefaultError('maxlength')">{{substituteParameters(getErrorMessage("maxLength"), {maxLength: attachedControl.errors.maxlength.requiredLength})}}</div>
		<div *ngIf="showDefaultError('pattern')">{{getErrorMessage("pattern")}}</div>
		<div *ngIf="showDefaultError('MatchPassword')">{{getErrorMessage("matchPassword")}}</div>
		<div *ngIf="showDefaultError('date')">{{getErrorMessage("date")}}</div>
		<div *ngIf="showDefaultError('message')">{{attachedControl.errors.message.value}}</div>
		<div [ngTemplateOutlet]="getCustomErrorHandler(getErrorToShow(forCalculation))?.templateRef"></div>
	</div>
</ng-template>

<ng-template #errorRef2 let-forCalculation="forCalculation">
	<div>
		<div *ngIf="showDefaultError('min')">{{substituteParameters(getErrorMessage("min"), {min: attachedControl.errors.min.min})}}</div>
		<div *ngIf="showDefaultError('max')">{{substituteParameters(getErrorMessage("max"), {max: attachedControl.errors.max.max})}}</div>
		<div *ngIf="showDefaultError('required')">{{getErrorMessage("required")}}</div>
		<div *ngIf="showDefaultError('email')">{{getErrorMessage("email")}}</div>
		<div *ngIf="showDefaultError('minlength')">{{substituteParameters(getErrorMessage("minLength"), {minLength: attachedControl.errors.minlength.requiredLength})}}</div>
		<div *ngIf="showDefaultError('maxlength')">{{substituteParameters(getErrorMessage("maxLength"), {maxLength: attachedControl.errors.maxlength.requiredLength})}}</div>
		<div *ngIf="showDefaultError('pattern')">{{getErrorMessage("pattern")}}</div>
		<div *ngIf="showDefaultError('MatchPassword')">{{getErrorMessage("matchPassword")}}</div>
		<div *ngIf="showDefaultError('date')">{{getErrorMessage("date")}}</div>
		<div *ngIf="showDefaultError('message')">{{attachedControl.errors.message.value}}</div>
		<div [ngTemplateOutlet]="getCustomErrorHandler(getErrorToShow())?.templateRef"></div>
	</div>
</ng-template>

<ng-container *ngIf="direction === 'horizontal' && !errorMessageAsTooltip" [ngTemplateOutlet]="errorRef"></ng-container>

<div class="componentContainer" [ngClass]="{hasCaption: caption || captionRef, vertical: direction === 'vertical', reverseOrder: swapInputAndCaption}" #internalComponentRef>
	<ng-container [ngTemplateOutlet]="captionTpl"></ng-container>
	<div class="captionDummyForSpaceCalculation" #captionDummyForSpaceCalculation *ngIf="hasRightOfCaptionError()">
		<ng-container [ngTemplateOutlet]="captionTpl" [ngTemplateOutletContext]="{forCalculation: true}"></ng-container>
	</div>
	<ng-container *ngIf="direction === 'vertical' && getErrorLocation() === 'belowCaption' && !errorMessageAsTooltip" [ngTemplateOutlet]="errorRef"></ng-container>
	<div class="inputContainer" [ngClass]="{
		percentageSpacing: captionSpacing === 'percentages' && spaceDistribution !== 'fixedInputWidth',
		'd30-70': spaceDistribution === '30-70',
		'd34-66': spaceDistribution === '34-66',
		'fixedInputWidth': spaceDistribution === 'fixedInputWidth'
	}">
		<ng-container *ngIf="errorMessageAsTooltip && shouldShowErrorMessages() && getErrorToShow()">
			<div class="errorTooltipTriangle"></div>
			<div class="errorTooltipTriangleWhite"></div>
			<div class="errorTooltip">
				<ng-container [ngTemplateOutlet]="errorRef"></ng-container>
			</div>
		</ng-container>
		<ng-content></ng-content>
	</div>
</div>

<ng-template #captionTpl let-forCalculation="forCalculation">
	<div class="caption" *ngIf="caption || captionRef"
			 [ngClass]="{
			hasErrors: getErrorToShow() && attachedControl.touched,
			percentageSpacing: captionSpacing === 'percentages' && spaceDistribution !== 'fixedInputWidth',
			'd30-70': spaceDistribution === '30-70',
			'd34-66': spaceDistribution === '34-66',
			'fixedInputWidth': spaceDistribution === 'fixedInputWidth',
			withErrorRightOfCaption: getErrorLocation() === 'rightOfCaption'
		}"
	>
		<div *ngIf="captionRef" class="captionRefContainer">
			<ng-container [ngTemplateOutlet]="captionRef"></ng-container>
			<div *ngIf="isRequired()">&nbsp;*</div>
		</div>
		<div *ngIf="!captionRef" class="captionText">{{caption}}<span *ngIf="isRequired()">&nbsp;*</span></div>
		<div class="rightOfCaptionError">
			<ng-container *ngIf="!forCalculation && hasRightOfCaptionError() && !isErrorMessageTruncated()" [ngTemplateOutlet]="errorRef"></ng-container>
			<ng-container *ngIf="forCalculation" [ngTemplateOutlet]="errorRef" [ngTemplateOutletContext]="{forCalculation: true}"></ng-container>
		</div>
	</div>
</ng-template>

<ng-template #tailTpl>
	<div class="errorTooltipContainer" [ngClass]="{alwaysOpen: shouldShowErrorTooltip()}">
		<div class="errorTooltipTriangle"></div>
		<div class="errorTooltipTriangleWhite"></div>
		<div class="errorTooltip">
			<i class="closeBtn">Ã—</i>
			<ng-container *ngIf="getErrorToShow()" [ngTemplateOutlet]="errorRef2"></ng-container>
			<div *ngIf="!getErrorToShow() && getWarningToShow()">{{getWarningToShow()}}</div>
		</div>
		<klp-form-warning-icon variant="fill" *ngIf="getErrorToShow()"></klp-form-warning-icon>
		<klp-form-warning-icon variant="line" *ngIf="!getErrorToShow() && getWarningToShow()"></klp-form-warning-icon>
	</div>
</ng-template>
